# =============================================================================
# Faux|Dash Docker Compose Configuration
# =============================================================================
#
# QUICK START:
#   1. Copy this file: cp docker-compose.sample.yml docker-compose.yml
#   2. Copy env file:  cp .env.example .env
#   3. Generate secret: openssl rand -base64 32
#   4. Add secret to .env as NEXTAUTH_SECRET
#   5. Start: docker compose up -d
#   6. Access: http://localhost:8080
#
# Default login: admin@fauxdash.local / admin
# CHANGE THIS IMMEDIATELY after first login!
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Main Application
  # ---------------------------------------------------------------------------
  app:
    # Use pre-built image from GitHub Container Registry:
    image: ghcr.io/sdenike/fauxdash:latest
    # Or build locally:
    # build: .

    ports:
      - "8080:8080"    # Change left side to use a different port (e.g., "3000:8080")

    environment:
      - NODE_ENV=production

      # -----------------------------------------------------------------------
      # Database Configuration
      # -----------------------------------------------------------------------
      # Options: sqlite (default), postgres, mysql
      - DB_PROVIDER=${DB_PROVIDER:-sqlite}

      # SQLite (default) - stores data in /data/fauxdash.db
      - SQLITE_FILE=${SQLITE_FILE:-/data/fauxdash.db}

      # PostgreSQL - uncomment and set in .env if using postgres
      # - DB_URL=${DB_URL:-postgresql://fauxdash:changeme@postgres:5432/fauxdash}

      # MySQL - uncomment and set in .env if using mysql
      # - DB_URL=${DB_URL:-mysql://fauxdash:changeme@mysql:3306/fauxdash}

      # -----------------------------------------------------------------------
      # Redis Cache (recommended for performance)
      # -----------------------------------------------------------------------
      - REDIS_ENABLED=${REDIS_ENABLED:-true}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}

      # -----------------------------------------------------------------------
      # Authentication (REQUIRED)
      # -----------------------------------------------------------------------
      # Generate with: openssl rand -base64 32
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      # Your deployment URL (change if using reverse proxy)
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:8080}

      # -----------------------------------------------------------------------
      # Optional: Weather API
      # -----------------------------------------------------------------------
      # Get free key at: https://www.weatherapi.com/
      # - WEATHERAPI_KEY=${WEATHERAPI_KEY}

      # -----------------------------------------------------------------------
      # Optional: GeoIP (visitor location analytics)
      # -----------------------------------------------------------------------
      # Get free MaxMind license at: https://www.maxmind.com/en/geolite2/signup
      # - GEOIP_PROVIDER=${GEOIP_PROVIDER:-maxmind}
      # - GEOIP_MAXMIND_LICENSE_KEY=${GEOIP_MAXMIND_LICENSE_KEY}

    volumes:
      # Database and configuration storage
      - fauxdash-data:/data

      # Downloaded favicon images (can grow large with many bookmarks)
      - fauxdash-favicons:/app/public/favicons

      # Application logs (viewable in Admin > Logs)
      - fauxdash-logs:/data/logs

      # Optional: Mount local GeoIP database
      # - ./GeoLite2-City.mmdb:/data/GeoLite2-City.mmdb:ro

    depends_on:
      - redis

    restart: unless-stopped

    # Optional: Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/setup/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ---------------------------------------------------------------------------
  # Redis Cache Server
  # ---------------------------------------------------------------------------
  # Provides caching for improved performance. Can be disabled by setting
  # REDIS_ENABLED=false in .env, but not recommended for production.
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    restart: unless-stopped

    # Optional: Expose Redis port for debugging
    # ports:
    #   - "6379:6379"

  # ---------------------------------------------------------------------------
  # Optional: PostgreSQL Database
  # ---------------------------------------------------------------------------
  # Uncomment this section if you prefer PostgreSQL over SQLite.
  # Also set in .env:
  #   DB_PROVIDER=postgres
  #   DB_URL=postgresql://fauxdash:changeme@postgres:5432/fauxdash
  #
  # postgres:
  #   image: postgres:16-alpine
  #   environment:
  #     POSTGRES_DB: fauxdash
  #     POSTGRES_USER: fauxdash
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   restart: unless-stopped
  #   # Optional: Expose port for external tools
  #   # ports:
  #   #   - "5432:5432"

  # ---------------------------------------------------------------------------
  # Optional: MySQL Database
  # ---------------------------------------------------------------------------
  # Uncomment this section if you prefer MySQL over SQLite.
  # Also set in .env:
  #   DB_PROVIDER=mysql
  #   DB_URL=mysql://fauxdash:changeme@mysql:3306/fauxdash
  #
  # mysql:
  #   image: mysql:8
  #   environment:
  #     MYSQL_DATABASE: fauxdash
  #     MYSQL_USER: fauxdash
  #     MYSQL_PASSWORD: ${MYSQL_PASSWORD:-changeme}
  #     MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-changeme}
  #   volumes:
  #     - mysql-data:/var/lib/mysql
  #   restart: unless-stopped
  #   # Optional: Expose port for external tools
  #   # ports:
  #   #   - "3306:3306"

# =============================================================================
# Named Volumes
# =============================================================================
# Docker manages these volumes. Data persists across container restarts.
# To backup: docker run --rm -v fauxdash-data:/data -v $(pwd):/backup alpine tar cvf /backup/backup.tar /data
# To restore: docker run --rm -v fauxdash-data:/data -v $(pwd):/backup alpine tar xvf /backup/backup.tar -C /
volumes:
  fauxdash-data:
    # SQLite database, settings, configuration
    # Location: /var/lib/docker/volumes/fauxdash_fauxdash-data/_data

  fauxdash-favicons:
    # Downloaded and processed favicon images
    # Can be safely deleted - favicons will be re-downloaded

  fauxdash-logs:
    # Application logs
    # Automatically rotated when exceeding 10MB

  redis-data:
    # Redis AOF persistence
    # Safe to delete - cache will rebuild

  # postgres-data:
  #   # PostgreSQL data files
  #
  # mysql-data:
  #   # MySQL data files

# =============================================================================
# Networks (optional - Docker creates default network automatically)
# =============================================================================
# Uncomment to use a custom network name
# networks:
#   default:
#     name: fauxdash-network
